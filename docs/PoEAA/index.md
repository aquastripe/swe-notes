# Patterns of Enterprise Application Architecture

企業級的應用程式架構。

## 架構

架構的定義還沒有達成共識。Ralph Johnson 認為架構是一個主觀的東西，是一群開發人員在一個專案中，對一個系統的設計所共享的理解。通常這種共享的理解，會以 **系統的主要元件** 以及 **它們是如何互動** 的形式出現。而且開發人員會希望盡早做出正確的決策，因為這個決策被認為是難以改變的。

架構的要素：

- 將系統最高層次分解成各個部分
- 難以改變

作者最喜歡的架構是分層。大多數的企業級應用程式都使用某種形式的分層架構 (layered architecture)。某些情況下 [管線與過濾器](https://docs.microsoft.com/en-us/azure/architecture/patterns/pipes-and-filters) 等其他方法也是有它的價值，不過作者不會討論這些情境，而是專注在分層架構的整體脈絡。

## 企業級應用程式

企業級應用程式通常涉及：

- 持續性資料
- 大量資料
- 多人同時存取資料
- 使用者介面
- 整合其他企業級應用程式
- 商業流程和資料概念不一致
- 複雜且不合邏輯的商業邏輯 (business logic)

## 效能考量

許多架構決策都與效能有關：

- 大多數的效能問題可以在系統啟動以後進行檢測，之後進行最佳化
- 但某些架構對效能的影響很難事後修補

在本書討論效能是很困難的，因為在測量之前，任何有關效能的建議都不該被視為事實。應該透過測量來驗證每一項建議。不論何時進行最佳化，都應該在最佳化前後進行測量，否則只是使程式碼難以閱讀而已。組態設定 (configuration) 的更動可能會使效能最佳化無效。因此，在升級新版本的虛擬機器、硬體、資料庫或任何東西之後，都必須測量效能最佳化來確保它們仍然有用。實際上，會發現過去為了提高效能而做的最佳化，在新的環境中卻會減損效能。

效能的另一個問題是術語不一致。以下是 **可擴充性 (Scalability)** 經常被用來表示的意思：

- **回應時間 (Response Time)**: 系統處理外部請求的時間。例如：UI 操作、伺服器 API 的呼叫。
- **回應能力 (Responsiveness)**: 系統確認請求的速度，而非處理請求的速度。例如：在複製檔案時提供進度條可以提高介面的回應能力，即使它不會縮短回應時間。
- **延遲時間 (Latency)**: 獲得任何形式的回應所需要的最短時間，即使應該完成的工作不存在。這通常是遠端系統的大問題，常常因為網路傳輸使得需要花幾秒鐘的時間得到回應，而開發人員無法改善延遲時間。所以應該盡量減少遠端呼叫。
- **處理能力 (Throughput)**: 給定時間內可以處理請求的能力。對企業級的應用程式來說，典型的測量標準是 **每秒多少交易數量 (transactions per second, tps)**。
- **效能 (Performance)**: 指的是 **回應時間** 或 **處理能力**，以對你來說重要的那個為主。從使用者角度來看，回應能力 比 回應時間 更重要；因此，以 回應時間 或 處理能力 為代價來換取 回應能力 的提升，可以提高效能。
- **負載 (Load)**: 系統承受的壓力，通常是一些其他測量的環境，像是回應時間。例如：某些請求的回應時間在 10 個使用者時為 0.5 秒，20 個使用者時為 2 秒。
- **負載靈敏度 (Load Sensitivity)**: 回應時間隨著負載變化的程度。例如：系統 A 在 10-20 使用者的回應時間為 0.5 秒；系統 B 在 10 個使用者時為 0.2 秒，20 個使用者時為 2 秒。這種情況下，系統 A 的負載靈敏度小於系統 B。也可以說，系統 B **衰退 (degradation)** 比系統 A 還要快。
- **效率 (Efficiency)**: 根據資源劃分的效能。例如：在 2 個 CPU 上取得 30 tps 的系統比在 4 個相同 CPU 上取得 40 tps 的系統更有效率。
- **產能 (Capacity)**: 最大有效的處理能力或負載。可能是一個絕對最大值，或是一個效能降到可以接受的臨界點。

可擴充性會測量所加入的資源如何影響效能指標，通常資源是硬體。例如：

- **垂直擴充 (Vertical Scalability, scaling up)**: 增加單一伺服器的更多能力，像是增加更多記憶體。
- **水平擴充 (Horizontal Scalability, scaling out)**: 增加更多伺服器。

在建置企業級系統時，建置硬體的可擴充性往往比產能甚至效率更有意義，因為它比較容易實現、比較便宜。
